<style>
  .sort-button {
    background-color: white;
  }

  .link {
    text-decoration: underline;
    color: blue;
  }
  .user-submitted-properties-table > tbody > tr > td {
    padding-right: 0px;
  }
  .user-submitted-properties-table > thead > tr > th {
    padding-right: 0px;
  }
</style>
<div class="padding">
  <form class="form-group" ng-submit='filter(1)'>
    <div class="row align-items-end">
      <div class="col-sm-2">
        <label for="search"><Strong>Search:</Strong></label>
        <div class="input-group input-group-sm ">
          <input type="search" class="form-control" placeholder="Seach here..." aria-label="Small"
            aria-describedby="inputGroup-sizing-sm" ng-model="search" ng-change="clearSearchBox()">
          <button class="btn btn-success btn-sm mx-2" type="submit">
            Search
          </button>
        </div>
      </div>
      <div class="col-sm-2">
        <label class="form-control-label"><Strong>Status :</Strong></label>
        <select class="custom-select" id="status_filter" style="width: 100%;" ng-model="statusFilter"
          ng-change="filter(1)">
          <option value="">({{aggregateStatus.All ? aggregateStatus.All : 0}}) All</option>
          <option value="blank">({{aggregateStatus.Blank ? aggregateStatus.Blank : 0}}) Blank</option>
          <option value="Live">({{aggregateStatus.Live ? aggregateStatus.Live : 0}}) Live</option>
          <option value="Deactivated">({{aggregateStatus.Deactivated ? aggregateStatus.Deactivated : 0}}) Deactivated</option>
          <option value="VerificationStage">({{aggregateStatus.VerificationStage ? aggregateStatus.VerificationStage : 0}}) Verification Stage</option>
          <option value="NotQualified">({{aggregateStatus.NotQualified ? aggregateStatus.NotQualified : 0}}) Not Qualified</option>
          <option value="First_discussion_pending">({{aggregateStatus.First_discussion_pending ? aggregateStatus.First_discussion_pending : 0}}) First discussion pending</option>
        </select>
      </div>
      <div class="col-sm-2">
        <label class="form-control-label"><Strong>Sub Status :</Strong></label>
        <select class="custom-select" id="sub_status_filter" style="width: 100%;" ng-model="subStatusFilter"
          ng-change="filter(1)">
          <option value="">-</option>
          <option ng-repeat="sub in subStatuses[statusFilter] track by $index" value={{sub}}>({{aggregateSubStatus[sub] ? aggregateSubStatus[sub] : 0}}) {{sub}}</option>
        </select>
      </div>
      <div class="col-sm-2">
        <label class="form-control-label" for="country"><strong>Filter by City:</strong></label>
        <input type="text" ng-model="cityFilter" placeholder="Select a City"
          uib-typeahead="address for address in getCities($viewValue)" class="form-control"
          typeahead-editable="typeaheadEditable">
      </div>
      <div class="col-sm-2">
        <label class="form-control-label" for="country"><strong>Filter by User:</strong></label>
        <select class="custom-select" id="user_filter" style="width: 100%;" ng-model="userFilter"
          ng-change="filter(1)">
          <option value="">-</option>
          <option ng-repeat="user in allUsers track by $index" value={{user._id}} class="d-flex justify-content-between"> 
            <span> {{user.name}} | </span> 
            <span> ({{user.country.code}})&nbsp;{{user.username}}</span></option>
        </select>
      </div>
      <div class="col-sm-2">
        <label class="form-control-label" for="property_status_filter"><strong>Filter by Property Status:</strong></label>
        <select class="custom-select" id="property_status_filter" style="width: 100%;" ng-model="propertyStatusFilter"
          ng-change="filter(1)">
          <option value="">-</option>
          <option value="Under Review">Under Review</option>
          <option value="Waiting For Approval">Waiting For Approval</option>
        </select>
      </div>
    </div>
  </form>


  <div class="row" style="margin-top: 5px !important;
          background: white;
          padding-top: 10px;
          border-radius: 10px;">
    <div class="col-md-12" style="margin: auto;">
      <h4 class="text-center" style="color: #9E9E9E; margin: 10px 0 20px 0;">List of User Submitted Properties</h4>
      <div class="mb-3 d-flex flex-row justify-content-center align-items-center" style="width:100%"
        ng-show="$root.isAuthorised(['Super Admin','Moderator','Deo','Sales Marketing'])">
        Total Results :
        <strong>{{showCount}}</strong>
      </div>
      <table class="table table-striped table-sm table-responsive user-submitted-properties-table">
        <thead>
          <tr class="text-nowrap">
            <th scope="col">#</th>
            <!-- <th scope="col" ng-click="changeSort('user')">
              Name
              <span class="" ng-show="showAsc">
                <i class="material-icons md-24" style="cursor: pointer;">&#xe5c5;</i>
              </span>
              <span class="" ng-show="!showAsc">
                <i class="material-icons md-24" style="cursor: pointer;">&#xe5c7;</i>
              </span>
            </th> -->
            <th scope="col">Customer</th>
            <th scope="col">
              Property<br>Name<br>
              <span>
                <button ng-class="(sortBy === 'property_name' && sortForm === 1) ? 'btn btn-sm':'btn btn-sm sort-button'"
                  ng-click="changeSort('property_name', 1)">
                  &uarr;
                </button>
                <button ng-class="(sortBy === 'name' && sortForm === -1) ? 'btn btn-sm':'btn btn-sm sort-button'"
                  ng-click="changeSort('property_name', -1)">
                  &darr;
                </button>
              </span>
            </th>
            <th scope="col">Email<br>Phone No</th>
            <th scope="col">Builder<br>
              <span>
                <button ng-class="(sortBy === 'builder' && sortForm === 1) ? 'btn btn-sm':'btn btn-sm sort-button'"
                  ng-click="changeSort('builder', 1)">
                  &uarr;
                </button>
                <button ng-class="(sortBy === 'builder' && sortForm === -1) ? 'btn btn-sm':'btn btn-sm sort-button'"
                  ng-click="changeSort('builder', -1)">
                  &darr;
                </button>
              </span>
            </th>
            <th scope="col">User<br>Submitted<br>City<br>
              <span>
                <button ng-class="(sortBy === 'userSubmittedCity' && sortForm === 1) ? 'btn btn-sm':'btn btn-sm sort-button'"
                  ng-click="changeSort('userSubmittedCity', 1)">
                  &uarr;
                </button>
                <button
                  ng-class="(sortBy === 'userSubmittedCity' && sortForm === -1) ? 'btn btn-sm':'btn btn-sm sort-button'"
                  ng-click="changeSort('userSubmittedCity', -1)">
                  &darr;
                </button>
              </span>
            </th>
            <th scope="col">City&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              <span>
                <button ng-class="(sortBy === 'city' && sortForm === 1) ? 'btn btn-sm':'btn btn-sm sort-button'"
                  ng-click="changeSort('city', 1)">
                  &uarr;
                </button>
                <button ng-class="(sortBy === 'city' && sortForm === -1) ? 'btn btn-sm':'btn btn-sm sort-button'"
                  ng-click="changeSort('city', -1)">
                  &darr;
                </button>
              </span>
            </th>
            <!-- <th scope="col">Case Id
              <span>
                <button ng-class="(sortBy === 'case_id_display' && sortForm === 1) ? 'btn btn-sm':'btn btn-sm sort-button'"
                  ng-click="changeSort('case_id_display', 1)">
                  &uarr;
                </button>
                <button ng-class="(sortBy === 'case_id_display' && sortForm === -1) ? 'btn btn-sm':'btn btn-sm sort-button'"
                  ng-click="changeSort('case_id_display', -1)">
                  &darr;
                </button>
              </span>
            </th> -->
            <th scope="col">Price<br>
              <span>
                <button ng-class="(sortBy === 'price' && sortForm === 1) ? 'btn btn-sm':'btn btn-sm sort-button'"
                  ng-click="changeSort('price', 1)">
                  &uarr;
                </button>
                <button ng-class="(sortBy === 'price' && sortForm === -1) ? 'btn btn-sm':'btn btn-sm sort-button'"
                  ng-click="changeSort('price', -1)">
                  &darr;
                </button>
              </span>
            </th>
            <th scope="col">Size<br>
              <span>
                <button ng-class="(sortBy === 'size' && sortForm === 1) ? 'btn btn-sm':'btn btn-sm sort-button'"
                  ng-click="changeSort('size', 1)">
                  &uarr;
                </button>
                <button ng-class="(sortBy === 'size' && sortForm === -1) ? 'btn btn-sm':'btn btn-sm sort-button'"
                  ng-click="changeSort('size', -1)">
                  &darr;
                </button>
              </span>
            </th>
            <th scope="col">Latest<br>Status</th>
            <th scope="col">Latest<br>Sub<br>Status</th>
            <th scope="col">Property<br>Status</th>
            <!-- <th scope="col">Submitted On</th> -->
            <th scope="col">
              Last<br>Modified<br>
              <span class="mx-2">
                <button ng-class="(sortBy === 'updated' && sortForm === 1) ? 'btn btn-sm':'btn btn-sm sort-button'"
                  ng-click="changeSort('updated', 1)">
                  &uarr;
                </button>
                <button ng-class="(sortBy === 'updated' && sortForm === -1) ? 'btn btn-sm':'btn btn-sm sort-button'"
                  ng-click="changeSort('updated', -1)">
                  &darr;
                </button>
              </span>
            </th>
            <th scope="col">
              Created<br>
              <span class="mx-2">
                <button ng-class="(sortBy === 'created' && sortForm === 1) ? 'btn btn-sm':'btn btn-sm sort-button'"
                  ng-click="changeSort('created', 1)">
                  &uarr;
                </button>
                <button ng-class="(sortBy === 'created' && sortForm === -1) ? 'btn btn-sm':'btn btn-sm sort-button'"
                  ng-click="changeSort('created', -1)">
                  &darr;
                </button>
              </span>
            </th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr ng-repeat="user in usersList track by $index">
            <th style ="word-break:normal;">{{((pageIndex-1)*10)+$index+1}}</th>
            <td style ="word-break:normal;">{{user.user.name}}<br>({{user.user.country.code}})&nbsp;{{user.user.username}}</td>
            <td style ="word-break:normal;">{{user.property_name}}</td>
            <td ng-if="user.username" style ="word-break:normal;">{{user.email}}<br>({{user.country.code}})&nbsp;{{user.username}}</td>
            <td ng-if="!user.username" style ="word-break:normal;">{{user.email}}<br>({{user.user.country.code}})&nbsp;{{user.user.username}}</td>
            <td style ="word-break:normal;">{{user.builder}}</td>
            <td style ="word-break:normal;">{{user.userSubmittedCity ? user.userSubmittedCity : user.city}}</td>
            <td style ="word-break:normal;">
              <div class="row justify-content-start align-items-center" ng-hide="user.edit">
                <p class="col-8 mb-0 pr-0" style="overflow-wrap: break-word;">{{user.city}}</p>
                <button class="btn btn-success btn-sm ml-1 col-3 p-0" style="font-size: 18px;"
                  ng-click="user.edit=true">&#9998;</button>
              </div>
              <div class="row justify-content-start align-items-center" ng-show="user.edit">
                <input type="text" id="city" ng-model="mappedCity" placeholder="Select a City"
                  autocomplete="off" uib-typeahead="address for address in getCities($viewValue)" class="form-control col-8"
                  typeahead-editable="typeaheadEditable" typeahead-on-select="disabledFlag=false">
                <button class="btn btn-success btn-sm col-3 ml-1 p-0" ng-disabled='disabledFlag'
                  ng-click="saveThisCity(user.username, user.case_id, mappedCity); disabledFlag=true; user.edit=false">&#10003</button>
              </div>
            </td>
            <!-- <td id="doc">{{user.case_id_display}}</td> -->
            <td style ="word-break:normal;">{{user.price}}</td>
            <td style ="word-break:normal;">{{user.size}}</td>
            <td style ="word-break:normal;">{{user.latestStatus}}</td>
            <td style ="word-break:normal;">{{user.latestSubStatus}}</td>
            <td style ="word-break:normal;">{{user.status}}</td>
            <!-- <td>{{user.submittedOn| date :'dd MMM yy, hh:mm a'}}</td> -->
            <td style ="word-break:normal;">{{user.updated | date :'dd MMM yy, hh:mm a'}}</td>
            <td style ="word-break:normal;">{{user.created | date :'dd MMM yy, hh:mm a'}}</td>
            <td class="w-125 d-flex flex-row justify-content-between align-items-center" style="width:270px; word-break:normal;">
              <p class="btn btn-sm btn-primary mb-0 cursor-pointer" ng-click="showNotesModal(user)">Add notes</p>
              <p class="btn btn-sm btn-secondary mb-0 cursor-pointer" ng-click="showHistoryModal(user)">History</p>

              <a href="/admin-panel#/app/property/add?case_id={{user.case_id_display}}"
                ng-if="user.status === 'Under Review' || !user.status" class="btn btn-sm btn-success">Property +</a>
              <a ng-click="getUrl(user.case_id_display);" ng-if="user.status === 'Waiting For Approval'"
                class="btn btn-sm btn-success">Link</a>
              <a ng-click="getUrl(user.case_id_display);"
                ng-if="user.isApproved && user.status !== 'Archieved'" style="color:white;"
                class="btn btn-sm btn-success">Link</a>
              <a ng-if="user.status == 'Archieved'" style="color:white;" class="btn btn-sm btn-info">Archieved</a>


            </td>
            
          </tr>
          <tr>
        </tbody>
      </table>

      <nav aria-label="Page navigation example">
        <ul class="pagination justify-content-center">
          <li class="page-item" data-ng-show="currentArrayIndex != 0" data-ng-click="previousPaginationArray()">
            <a class="page-link" href="" aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
              <span class="sr-only">Previous</span>
            </a>
          </li>
          <li class="page-item" data-ng-repeat="i in mainArray[currentArrayIndex] track by $index">
            <a ng-if="i === pageIndex" style="color: blue !important; font-weight: bold !important;" class="page-link" href="" data-ng-bind="i" data-ng-click="filter(i)"></a>
            <a ng-if="i !== pageIndex" class="page-link" href="" data-ng-bind="i" data-ng-click="filter(i)"></a>
          </li>
          <li class="page-item" data-ng-show="currentArrayIndex != mainArray.length-1"
            data-ng-click="nextPaginationArray()">
            <a class="page-link" href="" aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
              <span class="sr-only">Next</span>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</div>

<!-- Add notes Modal -->
<div class="modal fade" id="addNotesModal" tabindex="-1" role="dialog" aria-labelledby="addNotesModalLabel"
  aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addNotesModalLabel">Add a Note</h5>
        <button type="button" ng-click="blankFormFn()" id="closeCreateEditModal" class="close" data-dismiss="modal"
          aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body add-notes-modal-body">
        <form name="addNotesForm" class="form-horizontal" ng-submit=saveNotes()>
          <div class="form-group">
            <label for="usp-status">Status</label><span style="color: red"> *</span>
            <select class="custom-select w-100" ng-model="usp.status" id="usp-status" required>
              <option value="Live">Live</option>
              <option value="Deactivated">Deactivated</option>
              <option value="VerificationStage">Verification Stage</option>
              <option value="NotQualified">Not Qualified</option>
              <option value="First_discussion_pending">First discussion pending</option>
            </select>
          </div>
          <div class="form-group" data-ng-show="usp.status">
            <label for="usp-substatus">Sub Status</label>
            <span style="color: red">*</span>
            <select class="form-control" type="text" placeholder="date" id="usp-substatus"
              ng-model="usp.subStatus" required>
              <option data-ng-repeat="sub_status in subStatuses[usp.status] track by $index" value={{sub_status}}
                ng-attr-selected='sub_status === usp.subStatus'>
                {{sub_status}}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label for="username">Whatsapp Number</label>
            <!-- <span style="color: red">*</span> -->
            <div class="form-group row justify-content-between w-100 mx-0" style="position: relative;">
              <div ng-click="showPhoneCodeOptions('code', 'code-name', 'phone-code-list', 'phone-code-search')"
                class="position-relative form-control col-3 p-0 ps-1 d-flex justify-content-around align-items-center">
                <input type="text" class="w-100 mb-0 border-0 text-center" name="countryCode" id="code"
                  ng-model="phoneCode" readonly="readonly" required style="margin-bottom: 0px !important;">
                <input id="phone-code-search" type="text" placeholder="India" ng-model="phoneCodeSearchText"
                  class="phone-code-search w-100 p-2 mb-0 border-0 text-center" style="display: none;">
                <input type="text" class="w-100 d-none" name="countryName" id="code-name" ng-model="phoneCodeName"
                  readonly="readonly" required>
                <svg class="m-1" stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 20 20"
                  stroke-linecap="round" stroke-linejoin="round" height="18" width="18"
                  xmlns="http://www.w3.org/2000/svg">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </div>
              <div id="phone-code-list" class="phone-code-list bottom-0" style="display: none; position: absolute;">
                <div class="w-100 p-2">
                </div>
                <table class="p-2"></table>
              </div>
              <input class="form-control col-8" type="text"
                onkeypress="return event.keyCode === 8 || event.charCode >= 48 && event.charCode <= 57"
                ng-model="usp.whatsappNumber" placeholder="Whatsapp Number" id="whatsapp-number" required>
            </div>
          </div>
          <div class="form-group">
            <label for="notes">Notes</label>
            <!-- <span style="color: red"> *</span> -->
            <textarea id="usp-notes" name="notes" ng-model="usp.notes" class="form-control"
              placeholder="Enter your notes here" />
          </div>
          <hr />
          <button type="submit" class="btn btn-primary" id="submit-notes">Submit</button>
          <button class="btn btn-info" id="submitting-notes" disabled>Submitting ...</button>
        </form>
      </div>
    </div>
  </div>
</div>
<!-- End add notes modal -->

<!-- show history Modal -->
<div class="modal fade" id="showLeadsBuyerHistoryModal" tabindex="-1" role="dialog"
  aria-labelledby="showLeadsBuyerHistoryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg custom-modal-width" role="document">
    <div class="modal-content">
      <div class="modal-header align-items-start">
        <div>
          <h5 class="modal-title" id="showLeadsBuyerHistoryModalLabel">History</h5>
          <table>
            <tr>
              <td colspan="2">
                <!-- <strong> Name:</strong> -->
                <h6 class="mb-0 mt-4">{{userHistoryData.user.name}}({{userHistoryData.user.country.code}})&nbsp;{{userHistoryData.user.username}}</h6>
              </td>
            </tr>
            <tr>
              <td>
                <strong>Property&nbsp;Name:</strong>
              </td>
              <td>
                {{userHistoryData.property_name}}
              </td>
            </tr>
            <tr>
              <td>
                <strong>Submitted Email & Phone No.:</strong>
              </td>
              <td class="px-2">
                {{userHistoryData.email}}&nbsp;&&nbsp;({{userHistoryData.country.code}})&nbsp;{{userHistoryData.username}}
              </td>
            </tr>
            <tr>
              <td>
                <strong>Builder:</strong>
              </td>
              <td>
                {{userHistoryData.builder}}
              </td>
            </tr>
            <tr>
              <td>
                <strong>User&nbsp;Submitted&nbsp;City:</strong>
              </td>
              <td>
                {{userHistoryData.userSubmittedCity ? userHistoryData.userSubmittedCity : userHistoryData.city}}
              </td>
            </tr>
            <tr>
              <td>
                <strong>City:</strong>
              </td>
              <td>
                {{userHistoryData.city}}
              </td>
            </tr>
            <tr>
              <td>
                <strong>Price:</strong>
              </td>
              <td>
                {{userHistoryData.price}}
              </td>
            </tr>
            <tr>
              <td>
                <strong>Size:</strong>
              </td>
              <td>
                {{userHistoryData.size}} (sq.ft.)
              </td>
            </tr>
            <tr>
              <td>
                <strong>Property&nbsp;Status:</strong>
              </td>
              <td>
                {{userHistoryData.status}}
              </td>
            </tr>
          </table>  
        </div>
        <button type="button" ng-click="blankFormFn()" id="closeCreateEditModal" class="close" data-dismiss="modal"
          aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
          <div data-ng-show="userHistory.length > 0" class="table-responsive-history">
            <table class="table history-table">
              <thead class="history-modal-table-head">
                <tr class="text-nowrap">
                  <th scope="col">Status</th>
                  <th scope="col">Sub Status</th>
                  <th scope="col" class="notes">Notes</th>
                  <th scope="col">Whatsapp Number</th>
                  <th scope="col">Updated On</th>
                  <th scope="col">Updated By</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  data-ng-show="userHistory.length > 0"
                  ng-repeat="history in userHistory track by $index"
                >
                  <td>{{history.status || "-"}}</td>
                  <td>{{history.subStatus || "-"}}</td>
                  <td class="notes">{{history.notes}}</td>
                  <td>({{history.country.code}}) {{history.whatsappNumber}}</td>
                  <td>{{history.updated | date: "MMM dd yyyy hh:mm a"}}</td>
                  <td>{{history.updatedBy}}</td>
                </tr>
              </tbody>
            </table>
          </div>
        <div data-ng-show="userHistory.length === 0">
          <h4 class="text-muted">No History</h4>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- End show history modal -->